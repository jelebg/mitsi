<!DOCTYPE html>
<html style="height: 100%">
<head>
<TITLE>Mitsi graphs test</TITLE>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

<script src="../js/mitsi.graph.js"></script>

<script>

var testSet = [
  { name : "simple_1",
	start : "TEST.T1",
	finish : "TEST.T2",
	relations :[
	   {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
	],
	expectedResult : [
	  ["TEST.T1", "TEST.T2"]
	]
  },
  { name : "simple_2",
	start : "TEST.T1",
	finish : "TEST.T3",
	relations :[
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""},
   	   {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""}
	],
	expectedResult : [
       ["TEST.T1", "TEST.T2", "TEST.T3"]
  	]
  },
  { name : "simple_3",
	start : "TEST.T1",
	finish : "TEST.T5",
	relations :[
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""},
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""},
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""},
       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":["ID"], "rKeyColumnsStr":""}
	],
	expectedResult : [
	  ["TEST.T1", "TEST.T3", "TEST.T5"]
	]
  },
  { name : "double_1",
	start : "TEST.T1",
	finish : "TEST.T4",
	relations :[
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
	],
	expectedPathCount : 2
  },
  { name : "double_2",
	start : "TEST.T1",
	finish : "TEST.T5",
	relations :[
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T4","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
	],
	expectedPathCount : 2
  },
  { name : "double_3",
	start : "TEST.T1",
	finish : "TEST.T5",
	relations :[
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
       {"tableName":"T4","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
	],
	expectedPathCount : 2
  },
  { name : "double_4",
		start : "TEST.T1",
		finish : "TEST.T6",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T4","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T6","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T5","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T6","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 2
	},
	{ name : "no_path_1",
		start : "TEST.T1",
		finish : "TEST.T3",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 0
	},
	{ name : "cycle_1",
		start : "TEST.T1",
		finish : "TEST.T2",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T1","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 1,
		expectedResult : [
       	  ["TEST.T1", "TEST.T2"]
       	]
	},
	{ name : "cycle_2",
		start : "TEST.T1",
		finish : "TEST.T4",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 1,
		expectedResult : [
       	  ["TEST.T1", "TEST.T2", "TEST.T3", "TEST.T4"]
       	]
	},
	{ name : "cycle_3",
		start : "TEST.T1",
		finish : "TEST.T8",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T3","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T6","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T6","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T7","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T7","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T5","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T5","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T4","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T4","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T1","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T7","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T8","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 1,
		expectedResult : [
       	  ["TEST.T1", "TEST.T2", "TEST.T3", "TEST.T6", "TEST.T7", "TEST.T8"]
       	]
	},
	{ name : "multi_link_1",
		start : "TEST.T1",
		finish : "TEST.T2",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 1,
		expectedResult : [
       	  ["TEST.T1", "TEST.T2"]
       	]
	},
	{ name : "auto_cycle_1",
		start : "TEST.T1",
		finish : "TEST.T3",
		relations :[
	       {"tableName":"T1","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T2","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""},
	       {"tableName":"T2","tableOwner":"TEST","keyColumns":[],"keyColumnsStr":"","rTableName":"T3","rTableOwner":"TEST","rKeyColumns":[], "rKeyColumnsStr":""}
		],
		expectedPathCount : 1,
		expectedResult : [
       	  ["TEST.T1", "TEST.T2", "TEST.T3"]
       	]
	},
// TODO : big graphs (very connected an not)
 ];

function compareArray(t1, t2) {
	if(t1==null || t2==null) {
		return false;
	}
	if(t1.length != t2.length) {
		return false;
	}
	for(var i=0; i!=t1.length; i++) {
		if(t1[i] != t2[i]) {
			return false;
		}
	}
	return true;
}
function pathNamesToIndexes(graph, t) {
	var t2 = [];
	for(var i=0; i!=t.length; i++) {
		t2.push(graph.getIndex(t[i]));
	}
	return t2;
}

function arrayToString(t) {
	return 	t.join(",");
}
function pathToString(graph, t) {
	if(t == null) {
		return "(null)";
	}
	var str = "";
	for(var i=0; i!=t.length; i++) {
		if(i>0) {
			str = str + ",";
		}
		str = str + graph.getVertexName(t[i]);
	}
	return str;
}

function testExpectedResult(graph, paths, expectedPaths, testDescription) {
	for(var i=0; i!=expectedPaths.length; i++) {
		var ePath = expectedPaths[i];
		
		for(var j=0; j!=paths.length; j++) {
			var p = paths[j];
			if(compareArray(p, ePath)) {
				break;
			}
		}
		
		if(j==paths.length) {
			console.log("expected path no found : "+pathToString(graph, ePath) + " ("+testDescription+")");
			throw "expected result not found ("+testDescription+")";
		}
	}
}

function test() {
	var divResult = document.getElementById("divResult");
	
	try {
		for(var i=0; i!=testSet.length; i++) {
			var d = document.createElement("DIV");
			d.textContent = testSet[i].name;
			d.style.backgroundColor = "lightgrey";
			divResult.appendChild(d);
			
			testOne(testSet[i]);
			testCompleted(d, true);
		}
		
	}
	catch (e) {
		testCompleted(d, false);
		console.log(e);
	}
}

var kShortest = 5;
function testOne(testU) {
	console.log("testing : "+testU.name);
	
	var graph = new MitsiGraph(testU.relations);
	var start = graph.getIndex(testU.start);
	var finish = graph.getIndex(testU.finish);

	// all possible paths with DFS
	var timing1 = Date.now();
	var pathsDFS = graph.getAllPaths(start, finish, false)

	// single shortest path with Dijkstra
	var timing2 = Date.now();
	var dijkstraTable = graph.computeDijkstra(start, false);
	var pathDijkstra = graph.getShortestPath(dijkstraTable, start, finish);
	var pathsDijkstra = pathDijkstra ? [ pathDijkstra ] : [];
	
	// all equal distance shortest path with Eppstein
	var timing3 = Date.now();
	var tEppstein = graph.computeEppstein(start, finish, false);
	var pathEppsteinAllShortest = graph.getAllEqualsShortestPath(tEppstein, start, finish);

	// 5 shortest with Eppstein
	var timing4 = Date.now();
	var tEppstein2 = graph.computeEppstein(start, finish, false);
	var pathEppsteinKShortest = graph.getKShortestPath(tEppstein2, start, finish, kShortest);

	var timing5 = Date.now();

	if(testU.expectedResult) {
		var ePaths = [];
		for(var i=0; i!=testU.expectedResult.length; i++) {
			ePaths.push(pathNamesToIndexes(graph, testU.expectedResult[i]));
		}
		
		testExpectedResult(graph, pathsDFS, ePaths, "expected==DFS");
		testExpectedResult(graph, pathsDijkstra, ePaths, "expected==Dijkstra");
		testExpectedResult(graph, pathEppsteinAllShortest, ePaths, "expected==EppsteinAllShortest");
		testExpectedResult(graph, pathEppsteinKShortest, ePaths, "expected==EppsteinKShortest");
	}
	if(testU.expectedPathCount!==undefined) {
		if(pathsDFS.length != testU.expectedPathCount ||
			pathsDFS.length != testU.expectedPathCount ||
			pathEppsteinKShortest.length != testU.expectedPathCount ) {
			console.log("unexpected path count ("+testU.expectedPathCount+")")
			throw "unexpected path count";
		}
	}
	if(testU.expectedPathCount===undefined || testU.expectedPathCount>0) {
		testExpectedResult(graph, pathsDFS, pathsDijkstra, "DFS==Dijkstra");
		testExpectedResult(graph, pathsDFS, pathEppsteinAllShortest, "DFS==EppsteinAllShortest");
		testExpectedResult(graph, pathsDFS, pathEppsteinKShortest, "DFS==EppsteinKShortest");
	}

	console.log("test completed : "+testU.name);
	console.log(" - DFS                   : "+(timing2-timing1)+"ms");
	console.log(" - Dijkstra              : "+(timing3-timing2)+"ms");
	console.log(" - Eppstein/all shortest : "+(timing4-timing3)+"ms");
	console.log(" - Eppstein/"+kShortest+" shortest   : "+(timing5-timing4)+"ms");
	
}


function testCompleted(d, ok) {
	//var d = document.getElementById("divResult");
	if(ok) {
		d.style.backgroundColor = "green";
		//d.textContent = "SUCCESSFULL";
	}
	else {
		d.style.backgroundColor = "red";
		//d.textContent = "ERROR";
	}
}

</script>



</head>
<body onload="test();">

<div id="divResult" ></div>
<!-- div id="divResult" style="background-color:lightgrey;">Testing ...</div -->




</body>
</html>
